# AlertManageré…ç½®æ–‡ä»¶ - CET4å­¦ä¹ ç³»ç»Ÿå‘Šè­¦ç®¡ç†
# ç³»ç»Ÿç›‘æ§ä¸å‘Šè­¦ - ä»»åŠ¡7.3

global:
  # SMTPé…ç½®
  smtp_smarthost: 'smtp.qq.com:587'
  smtp_from: 'cet4-system@example.com'
  smtp_auth_username: 'cet4-system@example.com'
  smtp_auth_password: 'your_smtp_password'
  smtp_require_tls: true

  # ä¼ä¸šå¾®ä¿¡é…ç½®
  wechat_api_url: 'https://qyapi.weixin.qq.com/cgi-bin/'
  wechat_api_secret: 'your_wechat_secret'
  wechat_api_corp_id: 'your_corp_id'

  # é’‰é’‰é…ç½®
  # dingtalk_api_url: 'https://oapi.dingtalk.com/robot/send'

# è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default-receiver'
  routes:
    # ä¸¥é‡å‘Šè­¦è·¯ç”±
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      group_interval: 5s
      repeat_interval: 30m
      continue: true

    # ç³»ç»Ÿå‘Šè­¦è·¯ç”±
    - match:
        service: system
      receiver: 'system-alerts'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 2h

    # åº”ç”¨å‘Šè­¦è·¯ç”±
    - match:
        service: application
      receiver: 'application-alerts'
      group_wait: 15s
      group_interval: 2m
      repeat_interval: 1h

    # æ•°æ®åº“å‘Šè­¦è·¯ç”±
    - match:
        service: database
      receiver: 'database-alerts'
      group_wait: 10s
      group_interval: 1m
      repeat_interval: 30m

    # AIæœåŠ¡å‘Šè­¦è·¯ç”±
    - match:
        service: ai
      receiver: 'ai-service-alerts'
      group_wait: 20s
      group_interval: 5m
      repeat_interval: 2h

    # æˆæœ¬å‘Šè­¦è·¯ç”±
    - match_re:
        alertname: '.*Cost.*'
      receiver: 'cost-alerts'
      group_wait: 1m
      group_interval: 10m
      repeat_interval: 6h

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å½“æœ‰ä¸¥é‡å‘Šè­¦æ—¶ï¼ŒæŠ‘åˆ¶ç›¸åŒæœåŠ¡çš„è­¦å‘Šå‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service', 'instance']

  # å½“åº”ç”¨æœåŠ¡ä¸å¯ç”¨æ—¶ï¼ŒæŠ‘åˆ¶ç›¸å…³çš„æ€§èƒ½å‘Šè­¦
  - source_match:
      alertname: 'ApplicationDown'
    target_match_re:
      alertname: '(HighResponseTime|HighHTTPErrorRate|HighConcurrentConnections)'
    equal: ['instance']

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶å™¨
  - name: 'default-receiver'
    email_configs:
      - to: 'admin@example.com'
        subject: '[CET4ç³»ç»Ÿ] {{ .GroupLabels.alertname }} å‘Šè­¦'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          æœåŠ¡åç§°: {{ .Labels.service }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@example.com,ops@example.com'
        subject: '[CET4ç³»ç»Ÿ-ä¸¥é‡] {{ .GroupLabels.alertname }} å‘Šè­¦'
        body: |
          ğŸš¨ ä¸¥é‡å‘Šè­¦é€šçŸ¥ ğŸš¨
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          æœåŠ¡åç§°: {{ .Labels.service }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          è¯·ç«‹å³å¤„ç†ï¼
          {{ end }}
        headers:
          Priority: 'high'
    
    # ä¼ä¸šå¾®ä¿¡é€šçŸ¥
    wechat_configs:
      - agent_id: 'your_agent_id'
        to_user: '@all'
        to_party: 'ops_team'
        message: |
          ğŸš¨ CET4ç³»ç»Ÿä¸¥é‡å‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          æè¿°: {{ .Annotations.description }}
          æœåŠ¡: {{ .Labels.service }}
          æ—¶é—´: {{ .StartsAt.Format "15:04:05" }}
          {{ end }}

  # ç³»ç»Ÿå‘Šè­¦æ¥æ”¶å™¨
  - name: 'system-alerts'
    email_configs:
      - to: 'ops@example.com'
        subject: '[CET4ç³»ç»Ÿ-ç³»ç»Ÿ] {{ .GroupLabels.alertname }} å‘Šè­¦'
        body: |
          ç³»ç»Ÿèµ„æºå‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å®ä¾‹åœ°å€: {{ .Labels.instance }}
          å½“å‰å€¼: {{ .Annotations.value }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # åº”ç”¨å‘Šè­¦æ¥æ”¶å™¨
  - name: 'application-alerts'
    email_configs:
      - to: 'dev@example.com,ops@example.com'
        subject: '[CET4ç³»ç»Ÿ-åº”ç”¨] {{ .GroupLabels.alertname }} å‘Šè­¦'
        body: |
          åº”ç”¨æœåŠ¡å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          æœåŠ¡å®ä¾‹: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # æ•°æ®åº“å‘Šè­¦æ¥æ”¶å™¨
  - name: 'database-alerts'
    email_configs:
      - to: 'dba@example.com,ops@example.com'
        subject: '[CET4ç³»ç»Ÿ-æ•°æ®åº“] {{ .GroupLabels.alertname }} å‘Šè­¦'
        body: |
          æ•°æ®åº“æœåŠ¡å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          æ•°æ®åº“å®ä¾‹: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # AIæœåŠ¡å‘Šè­¦æ¥æ”¶å™¨
  - name: 'ai-service-alerts'
    email_configs:
      - to: 'ai-team@example.com,ops@example.com'
        subject: '[CET4ç³»ç»Ÿ-AIæœåŠ¡] {{ .GroupLabels.alertname }} å‘Šè­¦'
        body: |
          AIæœåŠ¡å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          æœåŠ¡å®ä¾‹: {{ .Labels.instance }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # æˆæœ¬å‘Šè­¦æ¥æ”¶å™¨
  - name: 'cost-alerts'
    email_configs:
      - to: 'finance@example.com,admin@example.com'
        subject: '[CET4ç³»ç»Ÿ-æˆæœ¬] {{ .GroupLabels.alertname }} å‘Šè­¦'
        body: |
          æˆæœ¬æ§åˆ¶å‘Šè­¦é€šçŸ¥
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å½“å‰æˆæœ¬: {{ .Annotations.value }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          è¯·å…³æ³¨æˆæœ¬æ§åˆ¶ï¼
          {{ end }}
        headers:
          Priority: 'high'

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'
