# AI 服务集成和 DeepSeek 优化规范

## 🤖 DeepSeek API 密钥池管理

### 密钥池配置要求

- **密钥数量**：15-25 个 API 密钥池
- **智能调度算法**：配额 35% + 成功率 25% + 响应时间 20% + 成本 10% + 错峰加权 10%
- **健康监控**：每 30 秒检查，异常密钥自动隔离
- **故障转移**：<5 秒内切换到备用密钥
- **错峰优惠**：北京时间 00:30-08:30 享受 2.5-5 折优惠

### 成本控制策略

- **缓存命中优化**：缓存命中仅 25%成本，目标命中率>70%
- **错峰调度**：成本敏感任务优先在错峰时段执行
- **预期优化效果**：总体 45%成本降低目标

## 🚀 AI 服务调用规范

### 强制要求

- **重试机制**：3 次重试，指数退避策略（1s、2s、4s、8s）
- **超时设置**：题目生成<2s，批改<3s，分析<5s
- **请求队列**：Redis 队列缓冲，最大 10000 个请求
- **熔断机制**：连续失败率>20%触发熔断
- **降级策略**：AI 服务不可用时提供缓存/模板结果

### 模型选择策略

- **deepseek-reasoner**：用于复杂推理和分析任务
- **deepseek-chat**：用于标准内容生成
- **流式输出**：stream=True 参数，AsyncGenerator 返回类型
- **实时性优先级**：urgent > high > normal > cost_sensitive

### 温度参数优化

- **批改任务**：1.0（准确性优先）
- **辅助功能**：1.3（平衡创意和准确性）
- **字幕生成**：1.3（自然流畅）
- **创意写作**：1.5（创意优先）
- **数据分析**：1.0（精确性优先）

## 📝 智能批改系统

### 流式批改实现

- **实时响应**：学生提交后立即开始流式返回
- **响应时间**：批改开始<1s，完整批改<3s，流式输出间隔<200ms
- **进度显示**：开始 → 进度 → 完成的完整流程
- **降级机制**：流式失败时提供缓存结果或模板评分

### 评分标准集成

- **四级评分**：15 分制，4 个维度评分
- **实时辅助**：边写边提示，响应时间<1s
- **结果解析**：总分、维度分、建议提取
- **Server-Sent Events**：EventSource 连接、消息格式、错误处理

## 🔍 AI 分析引擎

### 分析维度

- **个人维度**：知识点掌握度、学习进度、能力评估
- **班级维度**：整体水平、知识点分布、共性问题
- **数据融合**：正确率+用时+错误模式+学习频率
- **准确性要求**：分析准确性>90%，预测准确性>85%

### 内容生成质量控制

- **题目生成**：去重机制>95%，质量控制
- **教学大纲**：多阶段策略生成
- **教案生成**：个性化定制
- **热点融合**：考纲关联度 ≥80%
- **内容安全**：自动过滤和质量评估

## ⚡ 性能和稳定性

### 实时场景要求

- **响应时间**：批改<3s，辅助<1s，题目生成<2s
- **流式性能**：首字节时间<500ms，流式间隔<200ms
- **并发处理**：支持 1000+用户同时批改
- **优先级队列**：urgent 任务立即处理，不排队等待

### 监控和告警

- **性能监控**：实时响应时间记录、超时自动告警
- **成本监控**：日费用超预算 80%告警，95%限制
- **SLA 保障**：AI 服务可用性>99%，平均响应时间<3s

## 🛡️ 错误处理和降级

### 降级策略层级

1. **一级降级**：切换备用密钥
2. **二级降级**：使用缓存结果
3. **三级降级**：提供模板结果
4. **四级降级**：基础功能模式

### 错误处理规范

```python
# AI服务调用标准模式
async def call_ai_service(prompt: str, config: AIConfig) -> AIResponse:
    try:
        # 1. 检查缓存
        cached = await check_cache(prompt, config)
        if cached:
            return cached

        # 2. 选择最优密钥
        api_key = await select_optimal_key()

        # 3. 调用AI服务（带重试）
        response = await ai_client.chat.completions.create(
            model="deepseek-chat",
            messages=[{"role": "user", "content": prompt}],
            temperature=config.temperature,
            stream=config.stream,
            timeout=config.timeout
        )

        # 4. 缓存结果
        await cache_result(prompt, config, response)
        return response

    except AIServiceError as e:
        # 降级处理
        return await handle_degradation(prompt, config, e)
```

## 📊 成本优化实践

### 错峰调度实现

- **优惠时段**：北京时间 00:30-08:30
- **任务调度**：非紧急任务延迟到优惠时段
- **成本节省**：40-60%成本降低

### 智能缓存策略

- **高频内容**：词汇解释缓存 24 小时
- **学生分析**：个人分析缓存 1 小时
- **题目生成**：相似题目缓存 30 分钟
- **缓存命中**：目标 75%成本节省
