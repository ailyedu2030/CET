# 安全和数据保护要求规范

## 🔐 身份认证和授权

### JWT 认证机制

- **令牌生成**：RS256 算法，2048 位密钥
- **令牌过期**：访问令牌 15 分钟，刷新令牌 7 天
- **令牌存储**：HttpOnly Cookie + localStorage 双重存储
- **自动刷新**：无感知续期机制

### RBAC 权限控制

- **角色定义**：管理员(admin)、教师(teacher)、学生(student)
- **权限粒度**：操作级权限控制，精确到具体功能
- **权限继承**：支持权限继承和动态调整
- **权限检查**：运行时权限验证，拒绝未授权访问

### 多因素认证(MFA)

- **短信验证**：敏感操作二次验证
- **邮箱验证**：账户变更确认
- **设备绑定**：可信设备管理
- **异地登录**：异常登录检测和通知

## 🛡️ 数据加密和保护

### 数据加密标准

- **传输加密**：HTTPS + TLS 1.3，所有 API 通信加密
- **存储加密**：AES-256 加密敏感数据(学生信息、成绩)
- **密钥管理**：密钥轮换机制，定期更新加密密钥
- **数据库加密**：敏感字段透明加密

### 数据脱敏处理

- **开发环境**：所有真实数据必须脱敏
- **测试环境**：使用脱敏数据集进行测试
- **日志脱敏**：自动脱敏手机号、邮箱、身份证
- **导出脱敏**：数据导出时自动脱敏处理

## 🚨 输入验证和防护

### SQL 注入防护

- **参数化查询**：所有数据库查询使用参数化
- **ORM 优先**：优先使用 SQLAlchemy ORM
- **输入验证**：Pydantic 严格验证所有用户输入
- **权限最小化**：数据库用户权限最小化

### XSS 防护

- **输出编码**：所有用户输入输出时 HTML 编码
- **CSP 策略**：Content-Security-Policy 防护
- **输入过滤**：过滤危险 HTML 标签和 JavaScript
- **安全头设置**：X-XSS-Protection, X-Content-Type-Options

### CSRF 防护

- **CSRF Token**：所有状态变更操作验证 CSRF 令牌
- **SameSite Cookie**：Cookie 设置 SameSite=Strict
- **Referer 检查**：验证请求来源合法性
- **双重提交**：敏感操作双重验证机制

## 📊 安全监控和审计

### 操作审计日志

- **用户操作**：记录所有用户关键操作
- **系统事件**：记录登录、权限变更、数据修改
- **API 调用**：记录所有 API 请求和响应
- **日志保留**：审计日志保留 3 年，支持合规要求

### 异常行为检测

- **登录异常**：异地登录、频繁失败登录检测
- **操作异常**：批量操作、权限越界检测
- **数据异常**：大量数据访问、敏感数据导出检测
- **自动响应**：异常行为自动阻断和告警

### 会话安全配置

- **会话超时**：15 分钟无操作自动登出
- **并发控制**：同一用户最多 3 个并发会话
- **设备管理**：可信设备列表管理
- **强制登出**：管理员可强制用户登出

## 🔒 教育数据特殊保护

### 未成年人数据保护

- **数据最小化**：仅收集必要的学习数据
- **家长同意**：未成年人注册需家长确认
- **使用限制**：每日 2 小时使用时长限制
- **深夜禁用**：22:00-6:00 禁止访问

### 学习数据安全

- **成绩加密**：学生成绩和评价加密存储
- **访问控制**：学生只能查看自己的数据
- **数据匿名化**：统计分析时数据匿名化处理
- **删除权利**：支持学生数据删除请求

## 🛡️ 安全配置检查清单

### 开发阶段

- [ ] 所有 API 端点认证保护
- [ ] 敏感数据加密存储
- [ ] 输入验证完整实现
- [ ] SQL 注入防护到位
- [ ] XSS 和 CSRF 防护配置

### 测试阶段

- [ ] 安全测试通过
- [ ] 权限控制正确
- [ ] 数据脱敏生效
- [ ] 异常检测工作
- [ ] 审计日志完整

### 部署阶段

- [ ] HTTPS 正确配置
- [ ] 安全头设置完整
- [ ] 防火墙规则配置
- [ ] 监控告警启用
- [ ] 应急响应计划制定

## 🚨 安全事件响应

### 事件分类

- **P0 级**：数据泄露、系统入侵、服务中断
- **P1 级**：权限越界、异常访问、恶意攻击
- **P2 级**：登录异常、操作异常、配置错误
- **P3 级**：一般安全告警、日常监控事件

### 响应流程

1. **立即响应**：自动阻断可疑访问
2. **事件评估**：评估影响范围和严重程度
3. **应急处理**：采取相应的应急措施
4. **通知相关方**：及时通知相关责任人
5. **事后分析**：分析原因并制定改进措施

## 💡 使用指南

### 在 Cursor Chat 中使用

- "检查这个 API 的安全防护是否完整"
- "验证这个数据加密实现是否符合规范"
- "这个权限控制逻辑是否正确"
- "检查学生数据处理是否符合保护要求"
