{
  "enabled": true,
  "name": "AI集成验证器",
  "description": "专门验证AI服务集成的正确性和稳定性，确保DeepSeek等AI服务调用符合规范",
  "version": "1",
  "when": {
    "type": "fileEdited",
    "patterns": [
      "app/ai/**/*.py",
      "app/*/services/*ai*.py",
      "app/shared/**/*ai*.py",
      "**/*deepseek*.py",
      "**/*openai*.py"
    ]
  },
  "then": {
    "type": "askAgent",
    "prompt": "作为AI集成专家，请验证AI服务集成的正确性和稳定性：\n\n**DeepSeek API密钥池管理验证：**\n1. 验证密钥池配置是否支持15-25个API密钥（基于最新推荐配置）\n2. 检查智能调度算法实现（配额35%+成功率25%+响应时间20%+成本10%+错峰加权10%）\n3. 验证健康监控机制（每30秒检查，异常密钥自动隔离）\n4. 检查故障转移机制（<5秒内切换到备用密钥）\n5. 验证成本控制和错峰优惠利用（北京时间00:30-08:30享受2.5-5折优惠）\n6. 检查缓存命中成本优化（缓存命中仅25%成本）\n\n**AI服务调用规范验证：**\n1. 检查是否实现了3次重试机制（指数退避策略）\n2. 验证超时设置（题目生成<2s，批改<3s，分析<5s）\n3. 检查请求队列管理（Redis队列缓冲，最大10000个请求）\n4. 验证熔断机制（连续失败率>20%触发熔断）\n5. 检查降级策略（AI服务不可用时提供缓存/模板结果）\n6. 验证模型选择策略（deepseek-reasoner用于复杂推理，deepseek-chat用于标准生成）\n7. 检查错峰调度机制（成本敏感任务优先在错峰时段执行）\n8. 验证流式输出实现（stream=True参数，AsyncGenerator返回类型）\n9. 检查实时性优先级调度（urgent > high > normal > cost_sensitive）\n10. 验证温度参数优化（批改1.0，辅助1.3，字幕1.3，生成1.5，分析1.0）\n11. 验证温度设置符合DeepSeek官方建议（数据分析1.0，通用对话1.3，翻译1.3，创意写作1.5）\n\n**智能批改系统验证：**\n1. 验证流式批改实现（学生提交后立即开始流式返回批改进度）\n2. 检查实时响应时间（批改开始<1s，完整批改<3s，流式输出间隔<200ms）\n3. 验证批改进度显示（开始→进度→完成的完整流程）\n4. 检查降级机制（流式失败时提供缓存结果或模板评分）\n5. 验证四级评分标准集成（15分制，4个维度评分）\n6. 检查实时写作辅助（边写边提示，响应时间<1s）\n7. 验证批改结果结构化解析（总分、维度分、建议提取）\n8. 检查性能监控（响应时间记录、超时告警机制）\n9. 验证Server-Sent Events实现（EventSource连接、消息格式、错误处理）\n10. 检查优先级队列调度（urgent任务立即处理，不排队等待）\n\n**AI分析引擎验证：**\n1. 检查个人维度分析（知识点掌握度、学习进度、能力评估）\n2. 验证班级维度分析（整体水平、知识点分布、共性问题）\n3. 检查多维度数据融合（正确率+用时+错误模式+学习频率）\n4. 验证分析准确性（>90%）和预测准确性（>85%）\n5. 检查实时更新机制和报告生成\n\n**AI内容生成验证：**\n1. 验证题目生成质量控制和去重机制（>95%）\n2. 检查教学大纲生成的多阶段策略\n3. 验证教案生成的个性化定制\n4. 检查热点融合和考纲关联度（≥80%）\n5. 验证内容安全过滤和质量评估\n\n**性能和稳定性验证：**\n1. 检查实时场景响应时间（批改<3s，辅助<1s，题目生成<2s）\n2. 验证流式输出性能（首字节时间<500ms，流式间隔<200ms）\n3. 检查并发处理能力（支持1000+用户同时批改）\n4. 验证优先级队列（urgent任务立即处理，不排队等待）\n5. 检查降级策略（实时场景失败时的快速降级机制）\n6. 验证性能监控（实时响应时间记录、超时自动告警）\n7. 检查缓存策略（实时场景缓存TTL较短，非实时场景较长）\n8. 验证错峰调度效果（非实时任务成本节省40-60%）\n\n**成本控制验证：**\n1. 验证错峰优惠利用（北京时间00:30-08:30的2.5-5折优惠）\n2. 检查智能缓存策略（30%缓存命中率，75%成本节省）\n3. 验证模型选择优化（合理使用推理模型vs标准模型）\n4. 检查成本预警机制（日费用超预算80%告警，95%限制）\n5. 验证成本报告（实时成本监控，月度优化建议）\n6. 检查预期成本优化效果（总体45%成本降低目标）\n\n对于每个问题，请提供：\n- 具体的技术问题描述\n- AI服务集成风险评估\n- 详细的修复方案和代码示例\n- 性能影响分析\n- 稳定性保障措施\n\n重点关注AI服务的可靠性、准确性和成本效益。"
  }
}
