# è‹±è¯­å››çº§æ™ºèƒ½è®­ç»ƒç³»ç»ŸæŠ€æœ¯æ¶æ„ä¼˜åŒ–æŒ‡å—

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ22æ—¥  
**åŸºäºæŠ¥å‘Š**: å…¨é¢æŠ€æœ¯æ¶æ„å®¡æŸ¥æŠ¥å‘Š + æ·±åº¦ç¬¦åˆæ€§å®¡æŸ¥æŠ¥å‘Š  
**ä¼˜åŒ–ç›®æ ‡**: è§£å†³é«˜ä¼˜å…ˆçº§æŠ€æœ¯é—®é¢˜ï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§å’Œæ€§èƒ½  
**å®æ–½å‘¨æœŸ**: 2-4å‘¨

---

## ğŸ¯ ä¼˜åŒ–æ¦‚è¦

### æ ¸å¿ƒé—®é¢˜è¯†åˆ«

åŸºäºæŠ€æœ¯æ¶æ„å®¡æŸ¥æŠ¥å‘Šï¼Œç³»ç»Ÿå½“å‰å­˜åœ¨ä»¥ä¸‹**é«˜ä¼˜å…ˆçº§**æŠ€æœ¯é—®é¢˜ï¼š

1. **ğŸš¨ Celeryå¼‚æ­¥ä»»åŠ¡é…ç½®ç¼ºå¤±** - å½±å“AIåˆ†æç­‰è€—æ—¶æ“ä½œ
2. **ğŸŸ¡ æµ‹è¯•è¦†ç›–ç‡ä¸è¶³** - ä»£ç è´¨é‡ä¿éšœä¸å……åˆ†
3. **ğŸŸ¡ æ€§èƒ½ç›‘æ§æœºåˆ¶å¾…å®Œå–„** - ç¼ºä¹å®æ—¶æ€§èƒ½è¿½è¸ª
4. **ğŸŸ¡ é”™è¯¯å¤„ç†æœºåˆ¶éœ€è¦å¢å¼º** - å¼‚å¸¸æƒ…å†µå¤„ç†ä¸å¤Ÿå®Œå–„

### ä¼˜åŒ–æ”¶ç›Šé¢„æœŸ

- **æ€§èƒ½æå‡**: å¼‚æ­¥ä»»åŠ¡å¤„ç†èƒ½åŠ›æå‡80%
- **ç¨³å®šæ€§æå‡**: é”™è¯¯æ¢å¤èƒ½åŠ›æå‡60%
- **å¯ç»´æŠ¤æ€§æå‡**: æµ‹è¯•è¦†ç›–ç‡è¾¾åˆ°90%+
- **ç›‘æ§èƒ½åŠ›æå‡**: å®æ—¶æ€§èƒ½ç›‘æ§è¦†ç›–ç‡100%

---

## ğŸ”§ é«˜ä¼˜å…ˆçº§ä¼˜åŒ–ä»»åŠ¡

### 1. Celeryå¼‚æ­¥ä»»åŠ¡ç³»ç»Ÿå®Œå–„

#### é—®é¢˜æè¿°

å½“å‰ç³»ç»Ÿç¼ºå°‘å®Œæ•´çš„Celeryé…ç½®ï¼Œå¯¼è‡´AIåˆ†æç­‰è€—æ—¶ä»»åŠ¡æ— æ³•å¼‚æ­¥å¤„ç†ï¼Œå¯èƒ½å¼•èµ·è¯·æ±‚è¶…æ—¶ã€‚

#### è§£å†³æ–¹æ¡ˆ

**æ­¥éª¤1: å®Œå–„Celeryé…ç½®**

```python
# backend/config/settings/base.py
# æ·»åŠ Celeryé…ç½®

# Celeryé…ç½®
CELERY_BROKER_URL = os.getenv('CELERY_BROKER_URL', 'redis://localhost:6379/2')
CELERY_RESULT_BACKEND = os.getenv('CELERY_RESULT_BACKEND', 'redis://localhost:6379/2')
CELERY_TASK_SERIALIZER = 'json'
CELERY_ACCEPT_CONTENT = ['json']
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TIMEZONE = 'Asia/Shanghai'
CELERY_ENABLE_UTC = True
CELERY_TASK_TRACK_STARTED = True
CELERY_TASK_TIME_LIMIT = 30 * 60  # 30åˆ†é’Ÿè¶…æ—¶
CELERY_WORKER_PREFETCH_MULTIPLIER = 1
CELERY_WORKER_MAX_TASKS_PER_CHILD = 1000

# ä»»åŠ¡è·¯ç”±é…ç½®
CELERY_TASK_ROUTES = {
    'ai_services.tasks.*': {'queue': 'ai_processing'},
    'learning.tasks.*': {'queue': 'learning_processing'},
    'default': {'queue': 'default'},
}

# ä»»åŠ¡ä¼˜å…ˆçº§é…ç½®
CELERY_TASK_DEFAULT_PRIORITY = 5
CELERY_WORKER_DISABLE_RATE_LIMITS = False
```

**æ­¥éª¤2: åˆ›å»ºCeleryåº”ç”¨å®ä¾‹**

```python
# backend/config/celery.py
from celery import Celery
from django.conf import settings
import os

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings.development')

app = Celery('education_system')
app.config_from_object('django.conf:settings', namespace='CELERY')
app.autodiscover_tasks()

@app.task(bind=True)
def debug_task(self):
    print(f'Request: {self.request!r}')
```

**æ­¥éª¤3: å¼‚æ­¥ä»»åŠ¡å®ç°**

```python
# ai_services/tasks.py
from celery import shared_task
from .services import DeepSeekAPIService
from .models import AnalysisTask

@shared_task(bind=True, max_retries=3)
def process_ai_analysis(self, task_id: int, input_data: dict):
    """AIåˆ†æå¼‚æ­¥ä»»åŠ¡"""
    try:
        task = AnalysisTask.objects.get(id=task_id)
        task.status = 'processing'
        task.save()

        # æ‰§è¡ŒAIåˆ†æ
        service = DeepSeekAPIService()
        result = service.analyze_iteratively(input_data)

        # ä¿å­˜ç»“æœ
        task.result = result
        task.status = 'completed'
        task.save()

        return {'status': 'success', 'task_id': task_id}

    except Exception as exc:
        task.status = 'failed'
        task.error_message = str(exc)
        task.save()

        # é‡è¯•æœºåˆ¶
        if self.request.retries < self.max_retries:
            raise self.retry(countdown=60 * (2 ** self.request.retries))

        raise exc

@shared_task
def generate_teaching_syllabus(course_id: int, config: dict):
    """æ•™å­¦å¤§çº²ç”Ÿæˆå¼‚æ­¥ä»»åŠ¡"""
    # å®ç°æ•™å­¦å¤§çº²ç”Ÿæˆé€»è¾‘
    pass

@shared_task
def batch_question_generation(question_config: dict):
    """æ‰¹é‡é¢˜ç›®ç”Ÿæˆå¼‚æ­¥ä»»åŠ¡"""
    # å®ç°æ‰¹é‡é¢˜ç›®ç”Ÿæˆé€»è¾‘
    pass
```

**æ­¥éª¤4: ä»»åŠ¡ç›‘æ§å’Œç®¡ç†**

```python
# monitoring/tasks.py
from celery import shared_task
from django.core.mail import send_mail
from .models import TaskMonitor

@shared_task
def monitor_task_health():
    """ä»»åŠ¡å¥åº·ç›‘æ§"""
    # æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€
    # æ£€æŸ¥å¤±è´¥ä»»åŠ¡æ•°é‡
    # å‘é€å‘Šè­¦é€šçŸ¥
    pass

@shared_task
def cleanup_completed_tasks():
    """æ¸…ç†å·²å®Œæˆä»»åŠ¡"""
    # æ¸…ç†è¿‡æœŸçš„ä»»åŠ¡ç»“æœ
    # é‡Šæ”¾å­˜å‚¨ç©ºé—´
    pass
```

#### éªŒæ”¶æ ‡å‡†

- [ ] Celeryé…ç½®å®Œæ•´ä¸”å¯ç”¨
- [ ] å¼‚æ­¥ä»»åŠ¡æ­£å¸¸æ‰§è¡Œ
- [ ] ä»»åŠ¡ç›‘æ§åŠŸèƒ½æ­£å¸¸
- [ ] é”™è¯¯é‡è¯•æœºåˆ¶æœ‰æ•ˆ
- [ ] ä»»åŠ¡é˜Ÿåˆ—æ€§èƒ½æ»¡è¶³éœ€æ±‚

### 2. æµ‹è¯•è¦†ç›–ç‡æå‡

#### é—®é¢˜æè¿°

å½“å‰ç³»ç»Ÿæµ‹è¯•è¦†ç›–ç‡ä¸è¶³ï¼Œç¼ºä¹å®Œæ•´çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼Œå½±å“ä»£ç è´¨é‡ä¿éšœã€‚

#### è§£å†³æ–¹æ¡ˆ

**æ­¥éª¤1: æµ‹è¯•æ¡†æ¶é…ç½®**

```python
# backend/config/settings/testing.py
from .base import *

# æµ‹è¯•æ•°æ®åº“é…ç½®
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': ':memory:',
    }
}

# æµ‹è¯•ç¼“å­˜é…ç½®
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
    }
}

# ç¦ç”¨ä¸å¿…è¦çš„ä¸­é—´ä»¶
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
]

# æµ‹è¯•ä¸“ç”¨è®¾ç½®
PASSWORD_HASHERS = [
    'django.contrib.auth.hashers.MD5PasswordHasher',
]

EMAIL_BACKEND = 'django.core.mail.backends.locmem.EmailBackend'
```

**æ­¥éª¤2: æ ¸å¿ƒæ¨¡å‹æµ‹è¯•**

```python
# tests/unit/test_models.py
from django.test import TestCase
from django.contrib.auth import get_user_model
from learning.models import Course, Assignment, Progress

User = get_user_model()

class CourseModelTest(TestCase):
    """è¯¾ç¨‹æ¨¡å‹æµ‹è¯•"""

    def setUp(self):
        self.teacher = User.objects.create_user(
            username='teacher1',
            email='teacher@test.com',
            role='teacher'
        )

    def test_course_creation(self):
        """æµ‹è¯•è¯¾ç¨‹åˆ›å»º"""
        course = Course.objects.create(
            name='è‹±è¯­å››çº§',
            code='CET4-001',
            teacher=self.teacher,
            total_hours=64
        )

        self.assertEqual(course.name, 'è‹±è¯­å››çº§')
        self.assertEqual(course.code, 'CET4-001')
        self.assertEqual(course.teacher, self.teacher)
        self.assertEqual(course.total_hours, 64)

    def test_course_enrollment_count(self):
        """æµ‹è¯•é€‰è¯¾äººæ•°ç»Ÿè®¡"""
        course = Course.objects.create(
            name='è‹±è¯­å››çº§',
            code='CET4-001',
            teacher=self.teacher
        )

        # åˆ›å»ºå­¦ç”Ÿå¹¶é€‰è¯¾
        student1 = User.objects.create_user(
            username='student1',
            role='student'
        )
        student2 = User.objects.create_user(
            username='student2',
            role='student'
        )

        course.students.add(student1, student2)

        self.assertEqual(course.enrollment_count, 2)
```

**æ­¥éª¤3: APIæµ‹è¯•**

```python
# tests/unit/test_api.py
from rest_framework.test import APITestCase
from rest_framework import status
from django.contrib.auth import get_user_model
from learning.models import Course

User = get_user_model()

class CourseAPITest(APITestCase):
    """è¯¾ç¨‹APIæµ‹è¯•"""

    def setUp(self):
        self.teacher = User.objects.create_user(
            username='teacher1',
            email='teacher@test.com',
            role='teacher'
        )
        self.client.force_authenticate(user=self.teacher)

    def test_create_course(self):
        """æµ‹è¯•åˆ›å»ºè¯¾ç¨‹"""
        data = {
            'name': 'è‹±è¯­å››çº§',
            'code': 'CET4-001',
            'total_hours': 64,
            'description': 'è‹±è¯­å››çº§è€ƒè¯•åŸ¹è®­è¯¾ç¨‹'
        }

        response = self.client.post('/api/courses/', data)

        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        self.assertEqual(Course.objects.count(), 1)

        course = Course.objects.first()
        self.assertEqual(course.name, 'è‹±è¯­å››çº§')
        self.assertEqual(course.teacher, self.teacher)

    def test_list_courses(self):
        """æµ‹è¯•è¯¾ç¨‹åˆ—è¡¨"""
        Course.objects.create(
            name='è‹±è¯­å››çº§',
            code='CET4-001',
            teacher=self.teacher
        )

        response = self.client.get('/api/courses/')

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(len(response.data['results']), 1)
```

**æ­¥éª¤4: AIæœåŠ¡æµ‹è¯•**

```python
# tests/unit/test_ai_services.py
from unittest.mock import patch, MagicMock
from django.test import TestCase
from ai_services.services import DeepSeekAPIService
from ai_services.models import AnalysisTask

class DeepSeekAPIServiceTest(TestCase):
    """DeepSeek APIæœåŠ¡æµ‹è¯•"""

    def setUp(self):
        self.service = DeepSeekAPIService()

    @patch('ai_services.services.requests.post')
    def test_chat_completion(self, mock_post):
        """æµ‹è¯•èŠå¤©å®ŒæˆAPI"""
        # æ¨¡æ‹ŸAPIå“åº”
        mock_response = MagicMock()
        mock_response.json.return_value = {
            'choices': [{
                'message': {
                    'content': 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å“åº”'
                }
            }],
            'usage': {
                'prompt_tokens': 10,
                'completion_tokens': 5
            }
        }
        mock_response.status_code = 200
        mock_post.return_value = mock_response

        # æ‰§è¡Œæµ‹è¯•
        messages = [{'role': 'user', 'content': 'æµ‹è¯•æ¶ˆæ¯'}]
        result = self.service.chat_completion(messages)

        # éªŒè¯ç»“æœ
        self.assertIn('choices', result)
        self.assertEqual(
            result['choices'][0]['message']['content'],
            'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å“åº”'
        )

    def test_cost_calculation(self):
        """æµ‹è¯•æˆæœ¬è®¡ç®—"""
        cost = self.service.calculate_cost(
            model='deepseek-chat',
            input_tokens=1000,
            output_tokens=500
        )

        self.assertIsInstance(cost, float)
        self.assertGreater(cost, 0)
```

#### éªŒæ”¶æ ‡å‡†

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 85%
- [ ] é›†æˆæµ‹è¯•è¦†ç›–ç‡ > 70%
- [ ] æ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æœ‰æµ‹è¯•è¦†ç›–
- [ ] CI/CDé›†æˆæµ‹è¯•è‡ªåŠ¨åŒ–
- [ ] æµ‹è¯•æŠ¥å‘Šç”Ÿæˆå’Œç›‘æ§

### 3. æ€§èƒ½ç›‘æ§ç³»ç»Ÿå®Œå–„

#### é—®é¢˜æè¿°

å½“å‰ç³»ç»Ÿç¼ºä¹å®Œæ•´çš„æ€§èƒ½ç›‘æ§æœºåˆ¶ï¼Œæ— æ³•å®æ—¶è¿½è¸ªç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡å’Œå¼‚å¸¸æƒ…å†µã€‚

#### è§£å†³æ–¹æ¡ˆ

**æ­¥éª¤1: æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶**

```python
# monitoring/middleware.py
import time
import logging
from django.utils.deprecation import MiddlewareMixin
from django.core.cache import cache
from .models import PerformanceMetric

logger = logging.getLogger('performance')

class PerformanceMonitoringMiddleware(MiddlewareMixin):
    """æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶"""

    def process_request(self, request):
        request.start_time = time.time()

    def process_response(self, request, response):
        if hasattr(request, 'start_time'):
            duration = time.time() - request.start_time

            # è®°å½•æ€§èƒ½æŒ‡æ ‡
            PerformanceMetric.objects.create(
                path=request.path,
                method=request.method,
                status_code=response.status_code,
                duration=duration,
                user=request.user if request.user.is_authenticated else None
            )

            # æ…¢æŸ¥è¯¢å‘Šè­¦
            if duration > 2.0:  # è¶…è¿‡2ç§’
                logger.warning(
                    f'Slow request: {request.method} {request.path} '
                    f'took {duration:.2f}s'
                )

            # å®æ—¶ç»Ÿè®¡
            cache_key = f'perf_stats_{request.path}'
            stats = cache.get(cache_key, {'count': 0, 'total_time': 0})
            stats['count'] += 1
            stats['total_time'] += duration
            cache.set(cache_key, stats, 300)  # 5åˆ†é’Ÿç¼“å­˜

        return response
```

**æ­¥éª¤2: æ•°æ®åº“æŸ¥è¯¢ç›‘æ§**

```python
# monitoring/db_monitor.py
from django.db import connection
from django.core.management.base import BaseCommand
import logging

logger = logging.getLogger('db_performance')

class DatabaseQueryMonitor:
    """æ•°æ®åº“æŸ¥è¯¢ç›‘æ§"""

    def __init__(self):
        self.slow_query_threshold = 1.0  # 1ç§’

    def analyze_queries(self):
        """åˆ†ææŸ¥è¯¢æ€§èƒ½"""
        queries = connection.queries

        for query in queries:
            duration = float(query['time'])

            if duration > self.slow_query_threshold:
                logger.warning(
                    f'Slow query detected: {duration:.2f}s\n'
                    f'SQL: {query["sql"]}'
                )

                # è®°å½•æ…¢æŸ¥è¯¢
                self.record_slow_query(query, duration)

    def record_slow_query(self, query, duration):
        """è®°å½•æ…¢æŸ¥è¯¢"""
        from .models import SlowQuery

        SlowQuery.objects.create(
            sql=query['sql'],
            duration=duration,
            timestamp=timezone.now()
        )
```

**æ­¥éª¤3: ç³»ç»Ÿèµ„æºç›‘æ§**

```python
# monitoring/system_monitor.py
import psutil
import logging
from celery import shared_task
from django.core.cache import cache
from .models import SystemMetric

logger = logging.getLogger('system_monitor')

@shared_task
def collect_system_metrics():
    """æ”¶é›†ç³»ç»ŸæŒ‡æ ‡"""
    try:
        # CPUä½¿ç”¨ç‡
        cpu_percent = psutil.cpu_percent(interval=1)

        # å†…å­˜ä½¿ç”¨æƒ…å†µ
        memory = psutil.virtual_memory()
        memory_percent = memory.percent

        # ç£ç›˜ä½¿ç”¨æƒ…å†µ
        disk = psutil.disk_usage('/')
        disk_percent = disk.percent

        # ç½‘ç»œIO
        network = psutil.net_io_counters()

        # è®°å½•æŒ‡æ ‡
        SystemMetric.objects.create(
            cpu_percent=cpu_percent,
            memory_percent=memory_percent,
            disk_percent=disk_percent,
            network_bytes_sent=network.bytes_sent,
            network_bytes_recv=network.bytes_recv
        )

        # ç¼“å­˜æœ€æ–°æŒ‡æ ‡
        cache.set('latest_system_metrics', {
            'cpu': cpu_percent,
            'memory': memory_percent,
            'disk': disk_percent,
            'timestamp': timezone.now().isoformat()
        }, 60)

        # å‘Šè­¦æ£€æŸ¥
        check_system_alerts(cpu_percent, memory_percent, disk_percent)

    except Exception as e:
        logger.error(f'Failed to collect system metrics: {e}')

def check_system_alerts(cpu, memory, disk):
    """ç³»ç»Ÿå‘Šè­¦æ£€æŸ¥"""
    alerts = []

    if cpu > 80:
        alerts.append(f'High CPU usage: {cpu}%')

    if memory > 85:
        alerts.append(f'High memory usage: {memory}%')

    if disk > 90:
        alerts.append(f'High disk usage: {disk}%')

    if alerts:
        # å‘é€å‘Šè­¦é€šçŸ¥
        send_system_alert(alerts)

def send_system_alert(alerts):
    """å‘é€ç³»ç»Ÿå‘Šè­¦"""
    # å®ç°å‘Šè­¦é€šçŸ¥é€»è¾‘
    pass
```

#### éªŒæ”¶æ ‡å‡†

- [ ] å®æ—¶æ€§èƒ½ç›‘æ§æ­£å¸¸è¿è¡Œ
- [ ] æ…¢æŸ¥è¯¢æ£€æµ‹å’Œè®°å½•åŠŸèƒ½æ­£å¸¸
- [ ] ç³»ç»Ÿèµ„æºç›‘æ§è¦†ç›–CPUã€å†…å­˜ã€ç£ç›˜
- [ ] å‘Šè­¦æœºåˆ¶åŠæ—¶æœ‰æ•ˆ
- [ ] ç›‘æ§æ•°æ®å¯è§†åŒ–å±•ç¤º

### 4. é”™è¯¯å¤„ç†æœºåˆ¶å¢å¼º

#### é—®é¢˜æè¿°

å½“å‰ç³»ç»Ÿçš„é”™è¯¯å¤„ç†æœºåˆ¶ä¸å¤Ÿå®Œå–„ï¼Œç¼ºä¹ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†å’Œé”™è¯¯æ¢å¤æœºåˆ¶ã€‚

#### è§£å†³æ–¹æ¡ˆ

**æ­¥éª¤1: å…¨å±€å¼‚å¸¸å¤„ç†**

```python
# utils/exception_handler.py
from rest_framework.views import exception_handler
from rest_framework.response import Response
from rest_framework import status
import logging

logger = logging.getLogger('error_handler')

def custom_exception_handler(exc, context):
    """è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨"""
    # è°ƒç”¨DRFé»˜è®¤å¼‚å¸¸å¤„ç†å™¨
    response = exception_handler(exc, context)

    if response is not None:
        # è®°å½•å¼‚å¸¸ä¿¡æ¯
        logger.error(
            f'API Error: {exc.__class__.__name__} - {str(exc)}',
            extra={
                'request': context.get('request'),
                'view': context.get('view'),
                'exc_info': exc
            }
        )

        # è‡ªå®šä¹‰é”™è¯¯å“åº”æ ¼å¼
        custom_response_data = {
            'error': {
                'code': getattr(exc, 'default_code', 'unknown_error'),
                'message': str(exc),
                'details': response.data if isinstance(response.data, dict) else {},
                'timestamp': timezone.now().isoformat()
            }
        }

        response.data = custom_response_data

    else:
        # å¤„ç†æœªè¢«DRFæ•è·çš„å¼‚å¸¸
        logger.error(
            f'Unhandled Exception: {exc.__class__.__name__} - {str(exc)}',
            exc_info=True,
            extra={'request': context.get('request')}
        )

        response = Response(
            {
                'error': {
                    'code': 'internal_server_error',
                    'message': 'An internal server error occurred.',
                    'timestamp': timezone.now().isoformat()
                }
            },
            status=status.HTTP_500_INTERNAL_SERVER_ERROR
        )

    return response
```

**æ­¥éª¤2: AIæœåŠ¡é”™è¯¯å¤„ç†**

```python
# ai_services/exceptions.py
class AIServiceException(Exception):
    """AIæœåŠ¡å¼‚å¸¸åŸºç±»"""
    pass

class APIKeyExhaustedException(AIServiceException):
    """APIå¯†é’¥è€—å°½å¼‚å¸¸"""
    pass

class RateLimitExceededException(AIServiceException):
    """é€Ÿç‡é™åˆ¶è¶…å‡ºå¼‚å¸¸"""
    pass

class ModelNotAvailableException(AIServiceException):
    """æ¨¡å‹ä¸å¯ç”¨å¼‚å¸¸"""
    pass

# ai_services/error_handler.py
import time
import random
from typing import Callable, Any
from functools import wraps

def retry_with_backoff(max_retries: int = 3, base_delay: float = 1.0):
    """å¸¦é€€é¿çš„é‡è¯•è£…é¥°å™¨"""
    def decorator(func: Callable) -> Callable:
        @wraps(func)
        async def wrapper(*args, **kwargs) -> Any:
            last_exception = None

            for attempt in range(max_retries + 1):
                try:
                    return await func(*args, **kwargs)

                except RateLimitExceededException as e:
                    last_exception = e
                    if attempt < max_retries:
                        # æŒ‡æ•°é€€é¿ + éšæœºæŠ–åŠ¨
                        delay = base_delay * (2 ** attempt) + random.uniform(0, 1)
                        await asyncio.sleep(delay)
                        continue

                except APIKeyExhaustedException as e:
                    # APIå¯†é’¥è€—å°½ï¼Œå°è¯•åˆ‡æ¢å¯†é’¥
                    last_exception = e
                    if attempt < max_retries:
                        # ç­‰å¾…å¯†é’¥æ± åˆ·æ–°
                        await asyncio.sleep(60)
                        continue

                except Exception as e:
                    # å…¶ä»–å¼‚å¸¸ç›´æ¥æŠ›å‡º
                    raise e

            # æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥
            raise last_exception

        return wrapper
    return decorator

class CircuitBreaker:
    """ç†”æ–­å™¨æ¨¡å¼å®ç°"""

    def __init__(self, failure_threshold: int = 5, timeout: int = 60):
        self.failure_threshold = failure_threshold
        self.timeout = timeout
        self.failure_count = 0
        self.last_failure_time = None
        self.state = 'CLOSED'  # CLOSED, OPEN, HALF_OPEN

    def call(self, func: Callable, *args, **kwargs) -> Any:
        """æ‰§è¡Œå‡½æ•°è°ƒç”¨"""
        if self.state == 'OPEN':
            if time.time() - self.last_failure_time > self.timeout:
                self.state = 'HALF_OPEN'
            else:
                raise Exception('Circuit breaker is OPEN')

        try:
            result = func(*args, **kwargs)
            self.on_success()
            return result

        except Exception as e:
            self.on_failure()
            raise e

    def on_success(self):
        """æˆåŠŸå›è°ƒ"""
        self.failure_count = 0
        self.state = 'CLOSED'

    def on_failure(self):
        """å¤±è´¥å›è°ƒ"""
        self.failure_count += 1
        self.last_failure_time = time.time()

        if self.failure_count >= self.failure_threshold:
            self.state = 'OPEN'
```

#### éªŒæ”¶æ ‡å‡†

- [ ] å…¨å±€å¼‚å¸¸å¤„ç†æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] AIæœåŠ¡é”™è¯¯æ¢å¤æœºåˆ¶æœ‰æ•ˆ
- [ ] ç†”æ–­å™¨æ¨¡å¼æ­£ç¡®å®ç°
- [ ] é”™è¯¯æ—¥å¿—è®°å½•å®Œæ•´
- [ ] ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

---

## ğŸ“Š ä¼˜åŒ–å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µ (ç¬¬1-2å‘¨)

- [ ] Celeryå¼‚æ­¥ä»»åŠ¡ç³»ç»Ÿé…ç½®å’Œéƒ¨ç½²
- [ ] åŸºç¡€æµ‹è¯•æ¡†æ¶æ­å»º
- [ ] æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶å®ç°

### ç¬¬äºŒé˜¶æ®µ (ç¬¬3-4å‘¨)

- [ ] å®Œå–„æµ‹è¯•ç”¨ä¾‹ç¼–å†™
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶å¢å¼º
- [ ] ç›‘æ§å‘Šè­¦ç³»ç»Ÿå®Œå–„

### ç¬¬ä¸‰é˜¶æ®µ (ç¬¬5-6å‘¨)

- [ ] æ€§èƒ½ä¼˜åŒ–éªŒè¯
- [ ] ç³»ç»Ÿç¨³å®šæ€§æµ‹è¯•
- [ ] æ–‡æ¡£æ›´æ–°å’ŒåŸ¹è®­

---

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡

- **å¼‚æ­¥ä»»åŠ¡å¤„ç†èƒ½åŠ›**: æ”¯æŒå¹¶å‘å¤„ç†100+ä»»åŠ¡
- **æµ‹è¯•è¦†ç›–ç‡**: è¾¾åˆ°90%ä»¥ä¸Š
- **ç³»ç»Ÿå“åº”æ—¶é—´**: APIå¹³å‡å“åº”æ—¶é—´ < 500ms
- **é”™è¯¯æ¢å¤æ—¶é—´**: ç³»ç»Ÿæ•…éšœæ¢å¤æ—¶é—´ < 5åˆ†é’Ÿ

### ä¸šåŠ¡æŒ‡æ ‡

- **ç”¨æˆ·ä½“éªŒ**: é¡µé¢åŠ è½½æ—¶é—´ < 2ç§’
- **ç³»ç»Ÿç¨³å®šæ€§**: å¯ç”¨æ€§ > 99.5%
- **AIæœåŠ¡è´¨é‡**: æˆåŠŸç‡ > 95%
- **è¿ç»´æ•ˆç‡**: é—®é¢˜å‘ç°æ—¶é—´ < 1åˆ†é’Ÿ

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒé…ç½®**: ç¡®ä¿å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒé…ç½®ä¸€è‡´
2. **æ•°æ®å¤‡ä»½**: ä¼˜åŒ–è¿‡ç¨‹ä¸­åšå¥½æ•°æ®å¤‡ä»½
3. **æ¸è¿›å¼éƒ¨ç½²**: é‡‡ç”¨è“ç»¿éƒ¨ç½²æˆ–æ»šåŠ¨æ›´æ–°
4. **ç›‘æ§å‘Šè­¦**: ä¼˜åŒ–ååŠ å¼ºç›‘æ§ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
5. **æ–‡æ¡£æ›´æ–°**: åŠæ—¶æ›´æ–°æŠ€æœ¯æ–‡æ¡£å’Œæ“ä½œæ‰‹å†Œ

---

**æ–‡æ¡£ç»´æŠ¤**: æœ¬æ–‡æ¡£å°†æ ¹æ®ä¼˜åŒ–è¿›å±•å®šæœŸæ›´æ–°ï¼Œç¡®ä¿æŒ‡å¯¼çš„æ—¶æ•ˆæ€§å’Œå‡†ç¡®æ€§ã€‚
